name: Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

# Grant the workflow explicit permission to write security events so CodeQL can upload SARIF
permissions:
  security-events: write

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.25', 'nightly']
    # Allow nightly compiler runs to fail (nightly builds may be unstable)
    continue-on-error: ${{ matrix.go-version == 'nightly' }}

    steps:
    - name: Check out code
      uses: actions/checkout@v6

    - name: Set up Go (non-nightly)
      if: matrix.go-version != 'nightly'
      uses: actions/setup-go@v6
      with:
        go-version: ${{ matrix.go-version }}

    - name: Set up Go (nightly via gotip)
      if: matrix.go-version == 'nightly'
      uses: actions/setup-go@v6
      with:
        go-version: '1.25'

    - name: Install gotip for nightly runs
      if: matrix.go-version == 'nightly'
      shell: bash
      run: |
        set -eux
        export PATH="$(go env GOPATH)/bin:$PATH"
        go install golang.org/dl/gotip@latest
        gotip download
        mkdir -p $HOME/.local/bin
        # create a local 'go' shim that invokes gotip
        ln -sf "$(go env GOPATH)/bin/gotip" "$HOME/.local/bin/go"
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Cache Go modules
      uses: actions/cache@v5
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
    
    - name: Download dependencies
      run: go mod download
    
    - name: Verify dependencies
      run: go mod verify
    
    - name: Run go vet
      run: go vet ./...
    
    - name: Run go fmt check
      run: |
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "The following files are not formatted correctly:"
          gofmt -s -l .
          exit 1
        fi
    
    - name: Run unit tests
      run: |
        go test -v -race -coverprofile=coverage.out ./auth/...
        go test -v -race -coverprofile=coverage.out ./smtp/...
        go test -v -race -coverprofile=coverage.out ./storage/...
        go test -v -race -coverprofile=coverage.out ./server/...
    
    - name: Run integration tests
      run: |
        go test -v -race -coverprofile=integration_coverage.out -run TestSMTPIntegration .
        go test -v -race -coverprofile=tls_coverage.out -run TestTLSIntegration .
    
    - name: Run all tests with coverage
      run: |
        go test -v -race -coverprofile=combined_coverage.out -covermode=atomic ./...
    
#    - name: Upload coverage to Codecov
#      uses: codecov/codecov-action@v3
#      with:
#        file: ./combined_coverage.out
#        flags: unittests
#        name: codecov-umbrella
#        fail_ci_if_error: true
#
#    - name: Generate coverage report
#      run: go tool cover -html=combined_coverage.out -o coverage.html
#
#    - name: Upload coverage report
#      uses: actions/upload-artifact@v6
#      with:
#        name: coverage-report-${{ matrix.go-version }}
#        path: coverage.html
#
    - name: Run benchmarks
      run: go test -bench=. -benchmem ./... > benchmark_results.txt
    
    - name: Upload benchmark results
      uses: actions/upload-artifact@v6
      with:
        name: benchmark-results-${{ matrix.go-version }}
        path: benchmark_results.txt

  security:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Check out code
      uses: actions/checkout@v6
    
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25'

    - name: Gosec Security Checker
      uses: securego/gosec@v2.22.11
      with:
        args: '-no-fail -fmt sarif -out results.sarif ./...'
    
    - name: Upload SARIF file
      # Only attempt SARIF upload when running in a non-forked context. Uploading SARIF requires
      # the workflow to have the 'security-events' permission and will fail on pull requests from forks.
      if: ${{ github.event_name != 'pull_request' || (github.event.pull_request.head.repo.full_name == github.repository) }}
      uses: github/codeql-action/upload-sarif@v4
      env:
        # Suppress Node.js deprecation warnings (e.g. url.parse()) emitted from within the action's JS runtime.
        # This avoids noisy warnings in the Action log due to this bug: https://github.com/github/codeql-action/issues/3350.
        NODE_OPTIONS: --no-deprecation
      with:
        sarif_file: results.sarif

    - name: Run govulncheck
      run: |
        chmod +x .github/install-tools.sh || true
        .github/install-tools.sh
        govulncheck ./...

  build:
    runs-on: ubuntu-latest
    needs: test
    strategy:
      matrix:
        goos: [linux, windows, darwin]
        goarch: [amd64, arm64]
        exclude:
          - goos: windows
            goarch: arm64
    
    steps:
    - name: Check out code
      uses: actions/checkout@v6
    
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25'
    
    - name: Build binary
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
      run: |
        go build -ldflags="-s -w" -o badsmtp-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.goos == 'windows' && '.exe' || '' }} .
    
    - name: Upload binary
      uses: actions/upload-artifact@v6
      with:
        name: badsmtp-${{ matrix.goos }}-${{ matrix.goarch }}
        path: badsmtp-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.goos == 'windows' && '.exe' || '' }}

  docker:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Check out code
      uses: actions/checkout@v6
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      run: |
        docker build -t badsmtp:latest .
    
    - name: Test Docker image
      run: |
        docker run --rm badsmtp:latest --help
    
    - name: Save Docker image
      run: |
        docker save badsmtp:latest | gzip > badsmtp-docker-image.tar.gz
    
    - name: Upload Docker image
      uses: actions/upload-artifact@v6
      with:
        name: badsmtp-docker-image
        path: badsmtp-docker-image.tar.gz

  performance:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Check out code
      uses: actions/checkout@v6
    
    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25'
    
    - name: Run performance tests
      run: |
        mkdir -p perf
        rm -f performance_results.txt
        echo "Starting per-package benchmarks and profiles" > performance_results.txt
        for pkg in $(go list ./...); do
          safe=$(echo "$pkg" | sed 's/\//_/g')
          echo "\n==> PACKAGE: $pkg" >> performance_results.txt
          # Run benchmarks and collect mem/cpu profiles per-package. Do not fail the whole job if one package fails.
          go test -bench=. -benchmem -count=3 -memprofile=perf/mem_${safe}.prof -cpuprofile=perf/cpu_${safe}.prof $pkg >> performance_results.txt 2>&1 || true
        done

    - name: Upload performance results
      uses: actions/upload-artifact@v6
      with:
        name: performance-results
        path: |
          performance_results.txt
          perf/

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check out code
      uses: actions/checkout@v6
    
    - name: Set up Go
      uses: actions/setup-go@v6.1.0
      with:
        go-version: '1.25'

    - name: Run golangci-lint
      run: |
        chmod +x .github/install-tools.sh || true
        .github/install-tools.sh
        golangci-lint run --timeout=5m

    - name: Run staticcheck
      run: |
        chmod +x .github/install-tools.sh || true
        .github/install-tools.sh
        staticcheck ./...

  compatibility:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        go-version: ['1.25', 'nightly']
    # Allow nightly compatibility runs to fail
    continue-on-error: ${{ matrix.go-version == 'nightly' }}

    steps:
    - name: Check out code
      uses: actions/checkout@v6

    - name: Set up Go (non-nightly)
      if: matrix.go-version != 'nightly'
      uses: actions/setup-go@v6
      with:
        go-version: ${{ matrix.go-version }}

    - name: Set up Go (nightly via gotip)
      if: matrix.go-version == 'nightly'
      uses: actions/setup-go@v6
      with:
        go-version: '1.25'

    - name: Install gotip for nightly runs
      if: matrix.go-version == 'nightly'
      shell: bash
      run: |
        set -eux
        export PATH="$(go env GOPATH)/bin:$PATH"
        go install golang.org/dl/gotip@latest
        gotip download
        mkdir -p $HOME/.local/bin
        ln -sf "$(go env GOPATH)/bin/gotip" "$HOME/.local/bin/go"
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Run basic tests
      run: go test -short ./...

    - name: Build binary
      run: go build -o badsmtp${{ matrix.os == 'windows-latest' && '.exe' || '' }} .

    - name: Test binary
      run: ./badsmtp${{ matrix.os == 'windows-latest' && '.exe' || '' }} --help

  release:
    runs-on: ubuntu-latest
    needs: [test, security, build, docker, performance, lint, compatibility]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Check out code
      uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25'
    
    - name: Download all artifacts
      uses: actions/download-artifact@v7
    
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      id: create_release
      uses: actions/create-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        release_name: ${{ github.ref_name }}
        body: |
          Auto-generated release assets for ${{ github.ref_name }}
        draft: false
        prerelease: ${{ contains(github.ref_name, 'rc') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
